{% extends "base.html" %}
{% block title %}Register Student – Face Attendance System{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-8">
    <h2 class="mb-4"><i class="bi bi-person-plus me-2"></i>Register Student</h2>
    <div class="card shadow-sm">
      <div class="card-body">
        <form method="POST" id="registerForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Student ID <span class="text-danger">*</span></label>
              <input type="text" name="student_id" class="form-control"
                     placeholder="e.g. CS2025001" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Full Name <span class="text-danger">*</span></label>
              <input type="text" name="name" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input type="email" name="email" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Class</label>
              <select name="class_id" class="form-select">
                <option value="">— Select Class —</option>
                {% for cls in classes %}
                <option value="{{ cls.id }}">{{ cls.name }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Face capture -->
            <div class="col-12">
              <label class="form-label fw-semibold">Face Capture</label>
              <div class="d-flex flex-column align-items-start gap-2">
                <div class="position-relative">
                  <video id="regVideo" width="320" height="240"
                         class="border rounded bg-dark" autoplay muted playsinline></video>
                  <canvas id="regCanvas" width="320" height="240" class="d-none"></canvas>
                </div>
                <div class="d-flex gap-2">
                  <button type="button" class="btn btn-outline-secondary" id="startCamBtn"
                          onclick="startRegCamera()">
                    <i class="bi bi-camera me-1"></i>Start Camera
                  </button>
                  <button type="button" class="btn btn-outline-primary" id="captureFaceBtn"
                          onclick="captureFace()" disabled>
                    <i class="bi bi-camera-fill me-1"></i>Capture Face
                  </button>
                </div>
                <div id="capturePreview" class="d-none">
                  <img id="capturedImg" src="" alt="Captured face"
                       class="border rounded" width="160" height="120">
                  <p class="text-success small mt-1"><i class="bi bi-check-circle"></i> Face captured</p>
                </div>
                <input type="hidden" name="face_image" id="faceImageInput">
              </div>
            </div>
          </div>

          <div class="d-flex gap-2 mt-4">
            <button type="submit" class="btn btn-success">
              <i class="bi bi-person-check me-1"></i>Register
            </button>
            <a href="{{ url_for('students') }}" class="btn btn-secondary">Cancel</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let regStream = null;

function startRegCamera() {
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      regStream = stream;
      document.getElementById('regVideo').srcObject = stream;
      document.getElementById('captureFaceBtn').disabled = false;
      document.getElementById('startCamBtn').disabled = true;
    })
    .catch(err => alert('Camera access denied: ' + err.message));
}

function captureFace() {
  const video = document.getElementById('regVideo');
  const canvas = document.getElementById('regCanvas');
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, 320, 240);
  const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
  document.getElementById('faceImageInput').value = dataUrl;
  document.getElementById('capturedImg').src = dataUrl;
  document.getElementById('capturePreview').classList.remove('d-none');
  // Stop camera stream
  if (regStream) {
    regStream.getTracks().forEach(t => t.stop());
    regStream = null;
  }
}
</script>
{% endblock %}
