<!DOCTYPE html>
<html>
<head>
  <title>Standard {{ standard }}</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $(document).ready(function() {
      // Date picker change triggers AJAX reload
      $('#datePicker').on('change', function() {
        var date = $(this).val();
        loadAttendance(date);
      });

      // Send SMS button AJAX
      $('#sendSmsBtn').on('click', function(e) {
        e.preventDefault();
        var date = $('#datePicker').val();
        $('#smsResult').html('');
        $('#sendSmsBtn').prop('disabled', true);
        $('#loadingSpinner').show();
        $.post(window.location.pathname + '?date=' + date, {send_sms: 1, date: date}, function(data) {
          var html = $(data).find('#smsResult').html();
          $('#smsResult').html(html);
          loadAttendance(date, true);
        }).always(function() {
          $('#sendSmsBtn').prop('disabled', false);
          $('#loadingSpinner').hide();
        });
      });

      // Initial load
      // loadAttendance($('#datePicker').val());
    });

    function loadAttendance(date, skipSpinner) {
      if (!skipSpinner) $('#loadingSpinner').show();
      $.get(window.location.pathname + '?date=' + date, function(data) {
        var table = $(data).find('.attendance-table-section').html();
        $('.attendance-table-section').html(table);
        var stats = $(data).find('.mb-3').html();
        $('.mb-3').html(stats);
      }).always(function() {
        $('#loadingSpinner').hide();
      });
    }
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      min-height: 100vh;
      background-image: url('{{ url_for('static', filename='govt.jpg') }}');
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      padding: 0;
    }
    .students-card {
      width: 100%;
      max-width: 500px;
      padding: 2.5rem 1.5rem;
      box-shadow: 0 12px 40px rgba(37,99,235,0.13);
      background: linear-gradient(135deg, #f0f7ff 0%, #e0e7ff 100%);
      border-radius: 20px;
      border: 1.5px solid #2563eb;
      text-align: center;
      animation: fadeIn 0.7s cubic-bezier(.68,-0.55,.27,1.55) forwards;
    }
    .students-card h2 {
      color: #2563eb;
      font-weight: 700;
      margin-bottom: 1.2rem;
      letter-spacing: 1px;
      text-shadow: 0 2px 8px #dbeafe;
    }
    .table {
      margin-top: 1.5rem;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(37,99,235,0.10);
    }
    th, td {
      padding: 0.75rem 1rem;
      text-align: left;
    }
    th {
      background: #2563eb;
      color: #fff;
      font-weight: 600;
      border: none;
    }
    tr:nth-child(even) {
      background: #f3f4f6;
    }
    tr:nth-child(odd) {
      background: #e0e7ff;
    }
    tr:hover {
      background: #dbeafe !important;
      transition: background 0.2s;
    }
    .btn-primary, .btn-danger {
      font-size: 1.1rem;
      padding: 0.75rem 2rem;
      border-radius: 10px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(37,99,235,0.10);
      transition: background 0.2s, box-shadow 0.2s;
    }
    .btn-primary:hover, .btn-danger:hover {
      box-shadow: 0 4px 16px rgba(37,99,235,0.18);
      background: #1746a2;
    }
    @media (max-width: 600px) {
      .students-card {
        padding: 1rem 0.5rem !important;
        border-radius: 12px !important;
        box-shadow: 0 4px 16px rgba(37,99,235,0.10) !important;
      }
      .form-control, .btn {
        font-size: 1rem !important;
        padding: 0.7rem 1rem !important;
      }
      h2 {
        font-size: 1.5rem !important;
      }
    }
  </style>
</head>
<body>
  <div style="position:absolute;top:1.2rem;left:1.2rem;z-index:30;background:#fff;box-shadow:0 2px 8px rgba(37,99,235,0.14);border-radius:0px;padding:8px 12px;display:flex;align-items:center;justify-content:center;border:2px solid #2563eb;">
    <img src="{{ url_for('static', filename='govtt.png') }}" alt="Logo" style="display:block;max-width:180px;max-height:120px;object-fit:contain;" />
  </div>
  <div class="students-card">
    <h2 class="mb-4" style="color:#2563eb;font-weight:700;">Standard {{ standard }}</h2>
    <div class="row mb-3" style="justify-content:center;align-items:center;">
      <div class="col-12 col-md-6 mb-2">
    <input type="date" id="datePicker" class="form-control" value="{{ selected_date|replace('-', '-') }}" style="max-width:220px;margin:auto;" min="2020-01-01" max="{{ today_str }}">
      </div>
      <div class="col-12 col-md-6 mb-2">
        <button id="sendSmsBtn" class="btn btn-danger w-100">Send Email to Absentees</button>
        <span id="loadingSpinner" style="display:none;margin-left:10px;"><span class="spinner-border spinner-border-sm text-primary"></span> Loading...</span>
      </div>
    </div>
    <div id="smsResult">
      {% if sms_sent and sms_results %}
        <div class="alert alert-info mt-2" style="text-align:left;">
          <strong>Email Results:</strong><br>
          {% for email, success, error in sms_results %}
            {% if success %}
              <span style="color:green;">Email sent to {{ email }}</span><br>
            {% else %}
              <span style="color:red;">Failed to send email to {{ email }}: {{ error }}</span><br>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}
    </div>
    <div class="mb-3" style="font-size:1.1rem;color:#333;text-align:left;">
      <strong>Total Students:</strong> {{ total_students }}<br>
      <strong>Total Present:</strong> {{ total_present }}<br>
      <strong>Total Absent:</strong> {{ total_absent }}
    </div>
    <div class="attendance-table-section" style="background: linear-gradient(135deg, #e0e7ff 0%, #f0f7ff 100%); border-radius: 20px; box-shadow: 0 12px 40px rgba(37,99,235,0.13); padding: 1.5rem 1rem; margin-top: 1.5rem; max-width:540px; margin-left:auto; margin-right:auto; width:100%; overflow-x:auto;">
      <table class="table table-bordered mb-0" style="margin-bottom:0;width:100%;border-radius:12px;overflow:hidden;">
        <thead>
          <tr>
            <th>Roll Number</th>
            <th>Name</th>
            <th>DOB</th>
            <th>Parent Mobile</th>
            <th>Parent Email</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for s in students %}
          <tr>
            <td>{{ s.roll_number }}</td>
            <td>{{ s.full_name }}</td>
            <td>{{ s.dob }}</td>
            <td>{{ s.parent_mobile }}</td>
            <td>{{ s.parent_email }}</td>
            <td>
              {% if s.roll_number in attendance_times %}
                <span class="badge bg-success" style="font-size:1rem;padding:0.5em 1em;border-radius:8px;">Present ({{ attendance_times[s.roll_number] }})</span>
              {% else %}
                <span class="badge bg-danger" style="font-size:1rem;padding:0.5em 1em;border-radius:8px;">Absent</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <a href="/see_students" class="btn btn-primary mt-4" style="font-size:1.1rem;padding:0.75rem 2rem;border-radius:8px;">Back to Standards</a>
  </div>
</body>
</html>